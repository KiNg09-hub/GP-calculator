<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPM GP Calculator</title>

  <!-- Tailwind CDN + configure dark mode to follow device preference -->
  <script>
    // Tailwind config (use media so it follows system light/dark)
    tailwindConfig = { darkMode: 'media' };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* Extra minor styles for better printing/pdf and focus outlines */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    /* ensure PDF text contrast when copying innerText */
    .result-text { white-space: pre-wrap; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 to-sky-50 dark:from-slate-900 dark:to-slate-800 text-slate-800 dark:text-slate-200">

  <!-- Main container -->
  <div class="max-w-4xl mx-auto p-6">

    <!-- Card -->
    <div class="bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-700 rounded-2xl shadow-lg p-6">
      <!-- Header -->
      <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-3">
        <div>
          <h1 class="text-2xl font-bold text-indigo-700 dark:text-indigo-300">Kalkulator GP SPM</h1>
          <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
            Masukkan markah untuk setiap subjek — sistem akan keluarkan gred (huruf), jumlah markah & GP.
          </p>
        </div>

        <!-- Theme info -->
        <div class="text-sm text-slate-500 dark:text-slate-400">
          Tema: <span class="font-medium">Ikut sistem (light/dark)</span>
        </div>
      </header>

      <!-- Controls: subject count -->
      <section id="countSection" class="mb-5 grid sm:grid-cols-3 gap-3 items-end">
        <div class="sm:col-span-2">
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Jumlah Subjek SPM Diambil</label>
          <input id="totalSubjects" type="number" min="1" value="9"
                 class="mt-2 w-full p-3 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-100 focus:ring-2 focus:ring-indigo-400"
                 placeholder="Contoh: 9">
        </div>

        <div class="flex gap-2">
          <!-- Set button: hidden after generate -->
          <button id="setBtn" onclick="generateSubjects()"
                  class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg shadow">
            Set
          </button>

          <!-- Edit button: shown after Set to allow changes -->
          <button id="editBtn" onclick="enableEdit()" class="hidden w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 text-slate-700 dark:text-slate-200 font-semibold py-3 rounded-lg">
            Edit
          </button>
        </div>
      </section>

      <!-- Subjects list will be generated here -->
      <section id="subjectsContainer" class="space-y-4 mb-4"></section>

      <!-- Inline error area (duplicates etc.) -->
      <div id="errorBox" class="hidden mb-4 p-3 rounded-md bg-red-50 dark:bg-red-900/40 border border-red-100 dark:border-red-800 text-red-800 dark:text-red-200"></div>

      <!-- Action buttons -->
      <div class="flex gap-3">
        <button id="calcBtn" onclick="calculateGP()" class="hidden flex-1 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 rounded-lg shadow">
          Kira GP
        </button>

        <button id="downloadBtn" onclick="downloadPDF()" class="hidden flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg shadow">
          Muat Turun PDF
        </button>

        <button id="resetBtn" onclick="resetAll()" class="hidden bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 text-slate-700 dark:text-slate-200 font-semibold py-3 px-4 rounded-lg">
          Reset
        </button>
      </div>

      <!-- Result area -->
      <hr class="my-6 border-slate-100 dark:border-slate-700" />

      <section>
        <h2 class="text-lg font-semibold text-slate-800 dark:text-slate-200">Keputusan</h2>
        <div id="result" class="mt-3 bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-4 rounded-lg text-slate-700 dark:text-slate-200">
          <p class="text-sm text-slate-500 dark:text-slate-400">Tiada keputusan lagi. Tekan <span class="font-medium">Set</span> untuk mula.</p>
        </div>
      </section>
    </div>

    <!-- Footer note -->
    <p class="text-xs text-slate-500 dark:text-slate-400 mt-4 text-center">
      Tip: Jika tema gelap menyebabkan teks sukar dibaca pada beberapa peranti lama, cuba refresh atau gunakan mod light.
    </p>
  </div>

  <!-- ===========================
       JavaScript (all logic)
       - Preserves original getGradeData() EXACTLY
       - Prevents duplicate subjects
       - Hides set controls after generation
       - Shows grade letters (no numeric grade value in output)
       - Adds total marks / total actual marks
       - PDF export
       - Comments and indentation included
       ============================ -->
  <script>
    /*************************************************
     * ORIGINAL SUBJECT LIST (exactly as requested)
     *************************************************/
    const spmSubjects = [
      "Bahasa Melayu",
      "Bahasa Inggeris",
      "Matematik",
      "Sains",
      "Sejarah",
      "Matematik Tambahan",
      "Fizik",
      "Kimia",
      "Biologi",
      "Pendidikan Islam",
      "Pendidikan Moral",
      "Ekonomi",
      "Perakaunan",
      "Perniagaan",
      "Reka Bentuk & Teknologi (RBT)",
      "Sains Komputer",
      "Prinsip Perakaunan",
      "Geografi",
      "Kesusasteraan Melayu",
      "Kesusasteraan Tamil",
      "Seni Visual",
      "Pendidikan Jasmani & Kesihatan",
      "Bahasa Tamil",
      "Bahasa Cina",
      "Bahasa Arab",
      "Pendidikan Al-Quran dan Al-Sunnah",
      "Pendidikan Syariah Islamiah"
    ];

    /*************************************************
     * ORIGINAL GRADING FUNCTION (UNCHANGED)
     * Returns object { grade: "...", value: number }
     * NOTE: This is the exact 0-9 value system you provided.
     *************************************************/
    function getGradeData(mark) {
      if (mark >= 90) return { grade: "A+", value: 0 };
      if (mark >= 80) return { grade: "A",  value: 1 };
      if (mark >= 70) return { grade: "A-", value: 2 };
      if (mark >= 66) return { grade: "B+", value: 3 };
      if (mark >= 60) return { grade: "B",  value: 4 };
      if (mark >= 55) return { grade: "C+", value: 5 };
      if (mark >= 50) return { grade: "C",  value: 6 };
      if (mark >= 46) return { grade: "D",  value: 7 };
      if (mark >= 40) return { grade: "E",  value: 8 };
      if (mark >= 0)  return { grade: "F",  value: 9 };
      return { grade: "-", value: 0 };
    }

    /*************************************************
     * Helper to get DOM elements once
     *************************************************/
    const subjectsContainer = document.getElementById("subjectsContainer");
    const setBtn = document.getElementById("setBtn");
    const editBtn = document.getElementById("editBtn");
    const calcBtn = document.getElementById("calcBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const resetBtn = document.getElementById("resetBtn");
    const errorBox = document.getElementById("errorBox");
    const resultDiv = document.getElementById("result");
    const totalSubjectsInput = document.getElementById("totalSubjects");
    const countSection = document.getElementById("countSection");

    /*************************************************
     * Generate subject rows
     * - Creates dropdown (subject) + mark input for each subject
     * - Adds event listeners to detect duplicates immediately
     *************************************************/
    function generateSubjects() {
      const total = parseInt(totalSubjectsInput.value, 10);

      // validation
      if (!total || total <= 0) {
        alert("Sila masukkan bilangan subjek yang sah (>=1).");
        return;
      }

      // clear anything existing
      subjectsContainer.innerHTML = "";

      // create rows
      for (let i = 1; i <= total; i++) {
        const row = document.createElement("div");
        row.className = "bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-4 rounded-xl shadow-sm flex flex-col sm:flex-row sm:items-center gap-3";

        // left: label
        const label = document.createElement("div");
        label.innerHTML = `<div class="text-sm font-medium text-slate-700 dark:text-slate-200">Subjek ${i}</div>`;
        label.className = "w-full sm:w-1/4";
        row.appendChild(label);

        // middle: subject dropdown
        const selWrap = document.createElement("div");
        selWrap.className = "w-full sm:w-2/5";
        const select = document.createElement("select");
        select.className = "w-full p-3 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 focus:ring-2 focus:ring-indigo-400";
        select.setAttribute("data-subject", "");
        // default empty option
        select.innerHTML = `<option value="">-- Pilih Subjek (optional) --</option>` + spmSubjects.map(s => `<option value="${s}">${s}</option>`).join("");
        selWrap.appendChild(select);
        row.appendChild(selWrap);

        // right: mark input
        const inputWrap = document.createElement("div");
        inputWrap.className = "w-full sm:w-1/4";
        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.max = "100";
        input.placeholder = "Mark (0-100)";
        input.className = "w-full p-3 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 focus:ring-2 focus:ring-indigo-400";
        input.setAttribute("data-mark", "");
        inputWrap.appendChild(input);
        row.appendChild(inputWrap);

        // attach change listeners to check duplicates on change
        select.addEventListener("change", checkDuplicates);
        select.addEventListener("blur", checkDuplicates);
        input.addEventListener("input", () => { /* could add live validation if desired */ });

        subjectsContainer.appendChild(row);
      }

      // after generating, hide Set controls and show Edit / Calculate
      setBtn.classList.add("hidden");
      editBtn.classList.remove("hidden");
      calcBtn.classList.remove("hidden");
      resetBtn.classList.remove("hidden");

      // clear previous errors/results
      hideError();
      resultDiv.innerHTML = `<p class="text-sm text-slate-500 dark:text-slate-400">Sila masukkan markah untuk setiap subjek lalu tekan "Kira GP".</p>`;

      // lock the total input visually
      totalSubjectsInput.disabled = true;
      totalSubjectsInput.classList.add("opacity-60", "cursor-not-allowed");
    }

    /*************************************************
     * Enable editing (shows Set again)
     *************************************************/
    function enableEdit() {
      // show Set, hide Edit
      setBtn.classList.remove("hidden");
      editBtn.classList.add("hidden");
      calcBtn.classList.add("hidden");
      downloadBtn.classList.add("hidden");
      resetBtn.classList.add("hidden");

      // unlock inputs
      totalSubjectsInput.disabled = false;
      totalSubjectsInput.classList.remove("opacity-60", "cursor-not-allowed");

      // keep current rows but user can re-press Set after editing number (or manually remove)
    }

    /*************************************************
     * Reset everything to initial state
     *************************************************/
    function resetAll() {
      subjectsContainer.innerHTML = "";
      totalSubjectsInput.value = "9";
      totalSubjectsInput.disabled = false;
      totalSubjectsInput.classList.remove("opacity-60", "cursor-not-allowed");

      setBtn.classList.remove("hidden");
      editBtn.classList.add("hidden");
      calcBtn.classList.add("hidden");
      downloadBtn.classList.add("hidden");
      resetBtn.classList.add("hidden");

      hideError();
      resultDiv.innerHTML = `<p class="text-sm text-slate-500 dark:text-slate-400">Tiada keputusan lagi. Tekan <span class="font-medium">Set</span> untuk mula.</p>`;
    }

    /*************************************************
     * Check for duplicate subjects
     * - If duplicate found, display error and highlight them
     * - Returns true if duplicates exist
     *************************************************/
    function checkDuplicates() {
      const selects = Array.from(document.querySelectorAll("[data-subject]"));
      const values = selects.map(s => s.value.trim()).filter(v => v !== "");
      const duplicates = values.filter((v, i, a) => a.indexOf(v) !== i);

      // clear previous highlights
      selects.forEach(s => s.classList.remove("ring-2", "ring-red-400", "border-red-400"));

      if (duplicates.length > 0) {
        // highlight all selects that are duplicated
        selects.forEach(s => {
          if (duplicates.includes(s.value.trim()) && s.value.trim() !== "") {
            s.classList.add("ring-2", "ring-red-400", "border-red-400");
          }
        });

        // show error box
        showError(`Terdapat subjek yang dipilih lebih daripada sekali: ${[...new Set(duplicates)].join(", ")}. Sila pilih subjek berlainan.`);
        return true;
      } else {
        hideError();
        return false;
      }
    }

    /*************************************************
     * Show/Hide error helpers
     *************************************************/
    function showError(msg) {
      errorBox.innerText = msg;
      errorBox.classList.remove("hidden");
    }
    function hideError() {
      errorBox.innerText = "";
      errorBox.classList.add("hidden");
    }

    /*************************************************
     * Calculate GP & display results
     * - Will block if duplicates exist
     * - Shows grade letters only (no numeric grade values)
     * - Shows Total Marks / Total Actual Marks and percentage
     *************************************************/
    function calculateGP() {
      // first check duplicates
      if (checkDuplicates()) {
        // duplicates found; do not proceed
        return;
      }

      const markInputs = Array.from(document.querySelectorAll("[data-mark]"));
      const subjectSelects = Array.from(document.querySelectorAll("[data-subject]"));

      if (markInputs.length === 0) {
        alert("Tiada subjek dijana. Tekan Set dahulu.");
        return;
      }

      let totalValue = 0;           // sum of numeric grade values (for GP)
      let totalMarksObtained = 0;   // sum of marks input
      const rows = [];              // array to store per-subject results

      for (let i = 0; i < markInputs.length; i++) {
        const markRaw = markInputs[i].value;
        const mark = (markRaw === "" ? 0 : parseInt(markRaw, 10));
        const subj = subjectSelects[i].value || `Subjek ${i + 1}`;

        // preserve original grading logic
        const gd = getGradeData(mark);
        totalValue += gd.value;
        totalMarksObtained += (isNaN(mark) ? 0 : mark);

        rows.push({
          subject: subj,
          mark: isNaN(mark) ? 0 : mark,
          grade: gd.grade,
          value: gd.value
        });
      }

      const numSubjects = markInputs.length;
      const gp = (totalValue / numSubjects);
      const gpStr = gp.toFixed(2);

      // build result HTML (grade letters only, not numeric grade value)
      let html = `<div class="flex items-center justify-between mb-3">
                    <div>
                      <div class="text-lg font-bold text-indigo-700 dark:text-indigo-300">GP: ${gpStr}</div>
                      <div class="text-sm text-slate-500 dark:text-slate-400 mt-1">(${numSubjects} subjek)</div>
                    </div>
                    <div class="text-sm text-slate-600 dark:text-slate-300 text-right">
                      <div class="font-medium">Jumlah Markah: ${totalMarksObtained} / ${numSubjects * 100}</div>
                      <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">Peratus: ${((totalMarksObtained / (numSubjects * 100)) * 100).toFixed(2)}%</div>
                    </div>
                  </div>`;

      // list each subject row
      html += `<div class="space-y-2">`;
      rows.forEach(r => {
        html += `
          <div class="flex items-center justify-between bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-700 p-3 rounded-lg">
            <div>
              <div class="font-medium text-slate-800 dark:text-slate-200">${r.subject}</div>
              <div class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">Markah: ${r.mark}</div>
            </div>
            <div class="text-indigo-700 dark:text-indigo-300 font-bold text-lg">${r.grade}</div>
          </div>
        `;
      });
      html += `</div>`;

      // set result
      resultDiv.innerHTML = html;

      // show download button
      downloadBtn.classList.remove("hidden");
    }

    /*************************************************
     * PDF download
     * - Uses jsPDF (UMD build included)
     * - Exports subject, mark, grade, total marks, GP
     *************************************************/
    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });

      // Title
      doc.setFontSize(16);
      doc.text("Keputusan GP SPM", 40, 50);

      // retrieve summary text from resultDiv in a printable form
      const titleLine = resultDiv.querySelector(".text-lg")?.innerText || "";
      doc.setFontSize(12);
      doc.text(titleLine, 40, 80);

      // write the subject lines
      const rows = Array.from(document.querySelectorAll("[data-subject]")).map((s, idx) => {
        const subj = s.value || `Subjek ${idx + 1}`;
        const mark = document.querySelectorAll("[data-mark]")[idx].value || "0";
        const grade = getGradeData(parseInt(mark, 10)).grade;
        return `${idx + 1}. ${subj} — Markah: ${mark} — Gred: ${grade}`;
      });

      let y = 110;
      doc.setFontSize(11);
      for (let i = 0; i < rows.length; i++) {
        if (y > 750) {
          doc.addPage();
          y = 40;
        }
        doc.text(rows[i], 40, y);
        y += 18;
      }

      // total / gp
      // compute totals again (simple)
      const markInputs = Array.from(document.querySelectorAll("[data-mark]"));
      let totalMarks = 0;
      let totalValue = 0;
      markInputs.forEach(mi => {
        const m = parseInt(mi.value || "0", 10);
        totalMarks += isNaN(m) ? 0 : m;
        totalValue += getGradeData(m).value;
      });
      const n = markInputs.length || 1;
      const gp = (totalValue / n).toFixed(2);

      if (y > 700) { doc.addPage(); y = 40; }
      doc.text(`Total Markah: ${totalMarks} / ${n * 100}`, 40, y + 10);
      doc.text(`GP: ${gp}`, 40, y + 30);

      // save
      doc.save("SPM_GP_Result.pdf");
    }

    /*************************************************
     * Initialize small handlers:
     * - Allow pressing Enter on totalSubjects to trigger Set
     * - Listen for change in selects to check duplicates in real-time
     *************************************************/
    // Press Enter to set
    totalSubjectsInput.addEventListener("keyup", (e) => {
      if (e.key === "Enter") {
        generateSubjects();
      }
    });

    // When user changes any subject dropdown (delegated)
    subjectsContainer.addEventListener("change", () => {
      checkDuplicates();
    });

    // On page load, optionally generate default rows
    window.addEventListener("load", () => {
      // If you prefer auto-generate at load, uncomment:
      // generateSubjects();
    });
  </script>
</body>
</html>
