<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPM GP Calculator</title>

  <!-- Tailwind CDN (quick) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF (for PDF export) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* Extra small tweaks so inputs are readable in dark mode */
    input, select, textarea {
      /* Use system font for better rendering */
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    /* When a select/input is invalid (duplicate subject), show strong red border */
    .invalid {
      border-color: #dc2626 !important; /* red-600 */
      box-shadow: 0 0 0 4px rgba(220,38,38,0.06);
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 dark:text-gray-100">

  <!-- Main container -->
  <div class="max-w-4xl mx-auto p-6">

    <!-- Card -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 sm:p-8 border dark:border-gray-700">
      <header class="flex items-start justify-between gap-4">
        <div>
          <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-100">Kalkulator Gred Purata (GP) — SPM</h1>
          <p class="text-sm text-gray-500 dark:text-gray-300 mt-1">Masukkan subjek dan markah. Sistem akan kira GP (menggunakan nilai dalaman) — nilai dalaman tidak dipaparkan.</p>
        </div>

        <!-- Theme indicator -->
        <div class="text-sm text-gray-500 dark:text-gray-300">
          Theme: <span id="themeLabel" class="font-medium">Auto</span>
        </div>
      </header>

      <hr class="my-5 border-gray-100 dark:border-gray-700" />

      <!-- Controls area -->
      <div id="controls" class="grid sm:grid-cols-3 gap-4 items-end">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Jumlah Subjek</label>
          <input id="totalSubjects" type="number" min="1" value="9" 
                 class="mt-2 w-full p-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"> (Tekan Set untuk generate) </label>
          <button id="setBtn" onclick="generateSubjects()" 
                  class="mt-2 w-full p-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold">Set</button>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Actions</label>
          <div class="mt-2 flex gap-2">
            <button id="calcBtn" onclick="calculateGP()" class="flex-1 p-3 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white font-semibold hidden">Kira GP</button>
            <button id="downloadBtn" onclick="downloadPDF()" class="flex-1 p-3 rounded-lg bg-gray-700 hover:bg-gray-800 text-white font-semibold hidden">Muat Turun PDF</button>
            <button id="resetBtn" onclick="resetAll()" class="flex-1 p-3 rounded-lg bg-white border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 hidden">Reset</button>
          </div>
        </div>
      </div>

      <!-- Inline validation / duplicate notice -->
      <div id="notice" class="mt-4 text-sm text-red-600 hidden"></div>

      <!-- Subjects container -->
      <div id="subjectsContainer" class="mt-6 space-y-4"></div>

      <!-- Result output -->
      <div class="mt-6">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100">Keputusan</h2>
        <div id="result" class="mt-3 p-4 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-100 dark:border-gray-800">
          <p class="text-sm text-gray-500 dark:text-gray-400">-</p>
        </div>
      </div>

      <footer class="mt-6 text-xs text-gray-400">
        Nota: Nilai dalaman (numerical grade values) digunakan untuk pengiraan GP tetapi **tidak** dipaparkan pada laman. PDF akan mengandungi GP dan jumlah markah.
      </footer>
    </div>
  </div>

  <script>
    /* ===========================================================
       SPM GP Calculator
       - Keeps your original grade -> numeric value mapping EXACTLY
       - Prevents duplicate subject selection (shows inline error)
       - Hides the "Set" controls after generating subjects (shows Reset)
       - Shows grade letters and colored badges on website (no numeric nilai)
       - Calculates GP = (total numeric values) / (number of subjects)
       - Displays GP first then total marks in output
       - PDF export (black & white report-card style) with GP and total marks
       - Theme auto-detect (prefers-color-scheme)
       =========================================================== */

    /* ---------------------------
       1) YOUR ORIGINAL SUBJECT LIST
       ---------------------------- */
    const spmSubjects = [
      "Bahasa Melayu",
      "Bahasa Inggeris",
      "Matematik",
      "Sains",
      "Sejarah",
      "Matematik Tambahan",
      "Fizik",
      "Kimia",
      "Biologi",
      "Pendidikan Islam",
      "Pendidikan Moral",
      "Ekonomi",
      "Perakaunan",
      "Perniagaan",
      "Reka Bentuk & Teknologi (RBT)",
      "Sains Komputer",
      "Prinsip Perakaunan",
      "Geografi",
      "Kesusasteraan Melayu",
      "Kesusasteraan Tamil",
      "Seni Visual",
      "Pendidikan Jasmani & Kesihatan",
      "Bahasa Tamil",
      "Bahasa Cina",
      "Bahasa Arab",
      "Pendidikan Al-Quran dan Al-Sunnah",
      "Pendidikan Syariah Islamiah"
    ];

    /* -----------------------------------------
       2) Your exact grade -> numeric value map
       (UNCHANGED from your provided screenshot)
       ----------------------------------------- */
    function getGradeData(mark) {
      if (mark >= 90) return { grade: "A+", value: 0 };
      if (mark >= 80) return { grade: "A",  value: 1 };
      if (mark >= 70) return { grade: "A-", value: 2 };
      if (mark >= 66) return { grade: "B+", value: 3 };
      if (mark >= 60) return { grade: "B",  value: 4 };
      if (mark >= 55) return { grade: "C+", value: 5 };
      if (mark >= 50) return { grade: "C",  value: 6 };
      if (mark >= 46) return { grade: "D",  value: 7 };
      if (mark >= 40) return { grade: "E",  value: 8 };
      if (mark >= 0)  return { grade: "F",  value: 9 };
      return { grade: "-", value: 0 };
    }

    /* Color mapping for grade badges on website (not used in PDF) */
    const gradeColor = {
      "A+": "bg-green-600 text-white",
      "A":  "bg-green-500 text-white",
      "A-": "bg-emerald-500 text-white",
      "B+": "bg-yellow-500 text-black",
      "B":  "bg-amber-500 text-black",
      "C+": "bg-orange-400 text-black",
      "C":  "bg-orange-300 text-black",
      "D":  "bg-red-300 text-black",
      "E":  "bg-red-500 text-white",
      "F":  "bg-gray-600 text-white",
      "-":  "bg-gray-300 text-black"
    };

    /* DOM references */
    const container = document.getElementById('subjectsContainer');
    const calcBtn = document.getElementById('calcBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const resetBtn = document.getElementById('resetBtn');
    const setBtn = document.getElementById('setBtn');
    const totalSubjectsInput = document.getElementById('totalSubjects');
    const notice = document.getElementById('notice');
    const resultDiv = document.getElementById('result');

    /* -------------------------
       Generate subjects inputs
       - Hides the set controls once pressed
       - Adds subject dropdown + mark input
       - Adds onchange listener to detect duplicate subjects live
       -------------------------- */
    function generateSubjects() {
      const total = parseInt(totalSubjectsInput.value, 10);
      container.innerHTML = '';
      resultDiv.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">Siap untuk kira — tekan "Kira GP".</p>';
      notice.classList.add('hidden');
      notice.innerText = '';

      if (!total || total <= 0) {
        alert('Sila masukkan jumlah subjek (>=1).');
        return;
      }

      // build subject selector HTML once (options)
      const optionsHtml = spmSubjects.map(s => `<option value="${s}">${s}</option>`).join('');

      for (let i = 0; i < total; i++) {
        const block = document.createElement('div');
        block.className = 'bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-xl p-4 flex flex-col sm:flex-row sm:items-center gap-3';

        // label area
        const left = document.createElement('div');
        left.className = 'flex-1';
        left.innerHTML = `<div class="text-sm text-gray-700 dark:text-gray-300 font-medium mb-1">Subjek ${i+1}</div>
                          <select class="w-full p-2 rounded-md border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100" data-subject>
                            ${optionsHtml}
                          </select>`;
        block.appendChild(left);

        // mark input
        const right = document.createElement('div');
        right.className = 'w-48 flex-shrink-0';
        right.innerHTML = `<div class="text-sm text-gray-700 dark:text-gray-300 font-medium mb-1">Markah</div>
                           <input type="number" min="0" max="100" placeholder="0 - 100"
                                  class="w-full p-2 rounded-md border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100"
                                  data-mark />`;
        block.appendChild(right);

        // attach listeners for duplicate check on select change
        const selectEl = left.querySelector('[data-subject]');
        selectEl.addEventListener('change', validateDuplicates);
        container.appendChild(block);
      }

      // hide set controls, show calc & reset & download later
      setBtn.classList.add('hidden');
      totalSubjectsInput.classList.add('hidden');
      calcBtn.classList.remove('hidden');
      resetBtn.classList.remove('hidden');
      downloadBtn.classList.add('hidden');
      // scroll to subjects
      window.scrollTo({ top: container.offsetTop - 20, behavior: 'smooth' });
    }

    /* -------------------------
       Reset everything back to initial
       -------------------------- */
    function resetAll() {
      container.innerHTML = '';
      resultDiv.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">-</p>';
      notice.classList.add('hidden');
      notice.innerText = '';
      setBtn.classList.remove('hidden');
      totalSubjectsInput.classList.remove('hidden');
      calcBtn.classList.add('hidden');
      downloadBtn.classList.add('hidden');
      resetBtn.classList.add('hidden');
      totalSubjectsInput.value = 9;
      // show controls top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    /* -------------------------
       Validate duplicate subjects
       - highlights duplicates (adds .invalid)
       - shows notice if duplicates detected
       -------------------------- */
    function validateDuplicates() {
      const selects = Array.from(container.querySelectorAll('[data-subject]'));
      const seen = {};
      let hasDup = false;

      // clear old invalid states
      selects.forEach(s => s.classList.remove('invalid'));

      selects.forEach((sel, idx) => {
        const val = sel.value;
        if (!val) return;
        if (seen[val] !== undefined) {
          // mark both as invalid
          sel.classList.add('invalid');
          selects[seen[val]].classList.add('invalid');
          hasDup = true;
        } else {
          seen[val] = idx;
        }
      });

      if (hasDup) {
        notice.innerText = 'Ralat: Terdapat subjek yang dipilih lebih daripada sekali. Sila pastikan setiap subjek unik.';
        notice.classList.remove('hidden');
      } else {
        notice.classList.add('hidden');
        notice.innerText = '';
      }

      return !hasDup;
    }

    /* -------------------------
       Calculate GP
       - Enforces no duplicate subjects
       - Uses numeric grade values only internally
       - Displays GP first then total marks
       - Hides numeric grade values in website output (but shows letter grade)
       -------------------------- */
    function calculateGP() {
      // validate duplicates
      if (!validateDuplicates()) {
        alert('Sila betulkan pemilihan subjek yang sama dahulu.');
        return;
      }

      const selects = Array.from(container.querySelectorAll('[data-subject]'));
      const marks = Array.from(container.querySelectorAll('[data-mark]'));

      if (selects.length === 0) {
        alert('Sila set jumlah subjek dahulu.');
        return;
      }

      let totalValue = 0;   // sum of numeric grade values (hidden)
      let totalMarks = 0;   // sum of actual marks (displayed)
      const breakdown = [];

      for (let i = 0; i < selects.length; i++) {
        const subj = selects[i].value || `Subjek ${i+1}`;
        const markRaw = marks[i].value;
        const mark = (markRaw === '' || markRaw === null) ? 0 : Number(markRaw);
        // clamp mark 0-100
        const markClamped = isNaN(mark) ? 0 : Math.max(0, Math.min(100, mark));
        const gd = getGradeData(markClamped); // uses your exact mapping

        totalValue += gd.value;   // used for GP calculation (hidden from UI)
        totalMarks += markClamped;

        breakdown.push({
          subj,
          mark: markClamped,
          grade: gd.grade,
          value: gd.value
        });
      }

      // GP calculation: average numeric value per subject (kept standard)
      const gp = (totalValue / breakdown.length);
      const gpStr = gp.toFixed(2);

      // Build website result HTML:
      // Show GP first, then total marks, then breakdown (subject, mark, grade badge).
      let html = `<div class="flex items-center justify-between gap-4">
                    <div>
                      <div class="text-xl font-extrabold text-indigo-700 dark:text-indigo-300">GP: ${gpStr}</div>
                      <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">(${breakdown.length} subjek)</div>
                    </div>
                    <div class="text-right">
                      <div class="text-sm text-gray-600 dark:text-gray-300">Jumlah Markah</div>
                      <div class="text-lg font-semibold text-gray-800 dark:text-gray-100">${totalMarks}</div>
                    </div>
                  </div>`;

      // Breakdown list (creative card style, not plain table)
      html += `<div class="mt-4 grid gap-3">`;
      breakdown.forEach(row => {
        // badge color from mapping
        const cls = gradeColor[row.grade] || "bg-gray-300 text-black";
        html += `<div class="p-3 rounded-lg bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 flex items-center justify-between">
                   <div>
                     <div class="font-medium text-gray-800 dark:text-gray-100">${row.subj}</div>
                     <div class="text-sm text-gray-500 dark:text-gray-400">Markah: ${row.mark}</div>
                   </div>
                   <div class="ml-4">
                     <span class="px-3 py-1 rounded-full text-sm font-semibold ${cls}">${row.grade}</span>
                   </div>
                 </div>`;
      });
      html += `</div>`;

      resultDiv.innerHTML = html;
      downloadBtn.classList.remove('hidden');

      // scroll to result
      resultDiv.scrollIntoView({ behavior: 'smooth' });
    }

    /* -------------------------
       PDF export (black & white report card)
       - Includes GP (numeric), total marks, and each subject row
       - Styled (boxes, header) but in black & white
       - Uses jsPDF
       -------------------------- */
    function downloadPDF() {
      // first re-check duplicates and presence
      if (!validateDuplicates()) {
        alert('Sila betulkan pemilihan subjek yang sama dahulu.');
        return;
      }

      const selects = Array.from(container.querySelectorAll('[data-subject]'));
      const marks = Array.from(container.querySelectorAll('[data-mark]'));

      if (selects.length === 0) {
        alert('Tiada subjek untuk dimuat turun.');
        return;
      }

      // compute breakdown again (to ensure consistency)
      let totalValue = 0;
      let totalMarks = 0;
      const breakdown = [];

      for (let i = 0; i < selects.length; i++) {
        const subj = selects[i].value || `Subjek ${i+1}`;
        const markRaw = marks[i].value;
        const mark = (markRaw === '' || markRaw === null) ? 0 : Number(markRaw);
        const markClamped = isNaN(mark) ? 0 : Math.max(0, Math.min(100, mark));
        const gd = getGradeData(markClamped);

        totalValue += gd.value;
        totalMarks += markClamped;

        breakdown.push({
          subj,
          mark: markClamped,
          grade: gd.grade
        });
      }

      const gp = (totalValue / breakdown.length);
      const gpStr = gp.toFixed(2);

      // Build PDF using jsPDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        unit: "pt",
        format: "a4",
        orientation: "portrait"
      });

      // Page margins
      const marginLeft = 40;
      const pageWidth = doc.internal.pageSize.getWidth();
      const usableWidth = pageWidth - marginLeft * 2;

      // Header: Title box
      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.text("LAPORAN KEPUTUSAN SPM", marginLeft, 60);

      // Small meta info
      doc.setFontSize(11);
      doc.setFont("helvetica", "normal");
      const now = new Date();
      doc.text(`Tarikh dicetak: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`, marginLeft, 80);

      // Draw a box for GP and total marks
      doc.setDrawColor(0); // black lines
      doc.setLineWidth(0.7);
      // GP box
      doc.rect(marginLeft, 95, usableWidth * 0.35, 55); // x, y, w, h
      doc.rect(marginLeft + usableWidth * 0.36, 95, usableWidth * 0.62, 55);

      doc.setFontSize(12);
      doc.setFont("helvetica", "bold");
      doc.text("GP", marginLeft + 10, 118);
      doc.setFont("helvetica", "normal");
      doc.text(gpStr, marginLeft + 10, 138);

      doc.setFont("helvetica", "bold");
      doc.text("Jumlah Markah", marginLeft + usableWidth * 0.36 + 10, 118);
      doc.setFont("helvetica", "normal");
      doc.text(String(totalMarks), marginLeft + usableWidth * 0.36 + 10, 138);

      // Subject list: use creative card-like rows (not plain grid)
      let y = 165;
      const rowHeight = 28;
      doc.setFontSize(11);
      for (let i = 0; i < breakdown.length; i++) {
        const r = breakdown[i];
        // If near bottom, add new page
        if (y + rowHeight > doc.internal.pageSize.getHeight() - 60) {
          doc.addPage();
          y = 40;
        }

        // Draw a light rectangle (fill none, just border) to separate
        doc.rect(marginLeft, y - 18, usableWidth, rowHeight);

        // Subject name (left)
        doc.setFont("helvetica", "bold");
        doc.text(r.subj, marginLeft + 8, y);

        // Mark (mid)
        doc.setFont("helvetica", "normal");
        const markText = `Markah: ${r.mark}`;
        doc.text(markText, marginLeft + usableWidth * 0.55, y);

        // Grade (right) - styled box (black border, white fill)
        const gradeBoxW = 40;
        const gradeBoxX = marginLeft + usableWidth - gradeBoxW - 10;
        const gradeBoxY = y - 18 + 4;
        // draw grade box
        doc.rect(gradeBoxX, gradeBoxY, gradeBoxW, rowHeight - 8);
        doc.setFont("helvetica", "bold");
        // center grade text
        const txtWidth = doc.getTextWidth(r.grade);
        const txtX = gradeBoxX + (gradeBoxW - txtWidth) / 2;
        const txtY = y;
        doc.text(r.grade, txtX, txtY);
        y += rowHeight + 6;
      }

      // Footer
      const footerY = doc.internal.pageSize.getHeight() - 30;
      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");
      doc.text("Dijana oleh: SPM GP Calculator", marginLeft, footerY);

      // Save PDF
      doc.save("SPM_GP_Report.pdf");
    }

    /* -------------------------
       Theme handling - auto-detect and label
       - Tailwind's dark support uses 'class' mode in CDN; but we can rely on prefers-color-scheme
       - We only display the label here
       -------------------------- */
    function updateThemeLabel() {
      const darkQuery = window.matchMedia('(prefers-color-scheme: dark)');
      const label = document.getElementById('themeLabel');
      label.innerText = darkQuery.matches ? 'Dark (sistem)' : 'Light (sistem)';
    }
    updateThemeLabel();
    // listen for changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateThemeLabel);

    /* -------------------------
       On load: optional auto-generate subjects for convenience
       -------------------------- */
    window.addEventListener('load', () => {
      // Do nothing automatically; user must press Set
      // But we keep totalSubjects default value (9)
    });

  </script>
</body>
</html>
